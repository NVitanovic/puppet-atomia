#!/bin/sh

sed -i "/templatedir/d" /etc/puppet/puppet.conf

cd /etc/puppet
puppet resource package puppetdb ensure=latest
puppet resource service puppetdb ensure=running enable=true
puppet resource package puppetdb-terminus ensure=latest

echo -e "
:backends:
  - yaml
:hierarchy:
  - \"nodes/%{::fqdn}\"
  - \"%{::atomia_role}\"
  - \"%{::atomia_brand}_common\"
  - \"%{::kernel}\"
  - common
:yaml:
  :datadir: /etc/puppet/hieradata
" > /etc/puppet/hiera.yaml

echo "
node default {
        hiera_include('classes')
}
" > /etc/puppet/manifests/site.pp

echo "
[atomiacerts]
   path /etc/puppet/atomiacerts
   allow *
[atomia]
   path /etc/puppet/atomia
   allow *
" >> /etc/puppet/fileserver.conf

mkdir -p /etc/puppet/atomia/service_files

echo "
[main]
server = $HOSTNAME
port = 8081
" > /etc/puppet/puppetdb.conf

echo "
storeconfigs = true
storeconfigs_backend = puppetdb
" >> /etc/puppet/puppet.conf

echo "
---
master:
   facts:
      terminus: puppetdb
      cache: yaml
" >  /etc/puppet/routes.yaml

echo "mod \"atomia\", :git =>\"git://github.com/atomia/puppet-atomia.git\", :ref => \"stable\"" > Puppetfile

service puppetmaster restart

cd /etc/puppet

gem install librarian-puppet puppet
librarian-puppet install
cp /etc/puppet/modules/atomia/files/default_files/* /etc/puppet/atomia/service_files/
